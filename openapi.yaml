openapi: 3.0.3
info:
  title: FlowCore API
  description: |
    FlowCore は Xano のようなノーコードバックエンド構築基盤です。

    このAPIは以下の機能を提供します：
    - データベーステーブルの動的管理
    - APIエンドポイントのフロー定義と管理
    - 認証設定の管理
    - 動的エンドポイントの実行
  version: 1.0.0
  contact:
    name: FlowCore Development Team

servers:
  - url: http://localhost:8080
    description: ローカル開発環境
  - url: http://localhost:8080/api
    description: Runtime API (動的エンドポイント)

tags:
  - name: Health
    description: ヘルスチェック
  - name: Tables
    description: データベーステーブル管理
  - name: Endpoints
    description: APIエンドポイント管理
  - name: Auth
    description: 認証設定管理
  - name: Runtime
    description: 動的エンドポイント実行

paths:
  /health:
    get:
      tags:
        - Health
      summary: ヘルスチェック
      description: サーバーの稼働状態を確認
      responses:
        '200':
          description: サーバーが正常に稼働中
          content:
            text/plain:
              schema:
                type: string
                example: OK

  /admin/tables:
    get:
      tags:
        - Tables
      summary: テーブル一覧を取得
      description: すべてのテーブル定義を取得
      responses:
        '200':
          description: テーブル一覧の取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TablesResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Tables
      summary: テーブルを作成
      description: 新しいテーブル定義を作成し、実際のDBテーブルも生成
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTableRequest'
      responses:
        '201':
          description: テーブル作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Table'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/tables/{id}:
    put:
      tags:
        - Tables
      summary: テーブルを更新
      description: テーブル定義を更新（カラムの追加）
      parameters:
        - $ref: '#/components/parameters/TableID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTableRequest'
      responses:
        '200':
          description: テーブル更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Table'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Tables
      summary: テーブルを削除
      description: テーブル定義と実際のDBテーブルを削除
      parameters:
        - $ref: '#/components/parameters/TableID'
      responses:
        '200':
          description: テーブル削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: table deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/tables/{id}/import:
    post:
      tags:
        - Tables
      summary: CSVデータをインポート
      description: CSV形式のデータをテーブルにインポート（未完全実装）
      parameters:
        - $ref: '#/components/parameters/TableID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CSVImportRequest'
      responses:
        '200':
          description: インポート成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: CSV imported successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/endpoints:
    get:
      tags:
        - Endpoints
      summary: エンドポイント一覧を取得
      description: すべてのエンドポイント定義を取得
      responses:
        '200':
          description: エンドポイント一覧の取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EndpointsResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Endpoints
      summary: エンドポイントを作成
      description: 新しいAPIエンドポイント定義を作成
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEndpointRequest'
      responses:
        '201':
          description: エンドポイント作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Endpoint'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/endpoints/{id}:
    get:
      tags:
        - Endpoints
      summary: エンドポイント詳細を取得
      description: 指定されたIDのエンドポイント定義を取得
      parameters:
        - $ref: '#/components/parameters/EndpointID'
      responses:
        '200':
          description: エンドポイント取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Endpoint'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Endpoints
      summary: エンドポイントを更新
      description: エンドポイント定義を更新
      parameters:
        - $ref: '#/components/parameters/EndpointID'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEndpointRequest'
      responses:
        '200':
          description: エンドポイント更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Endpoint'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Endpoints
      summary: エンドポイントを削除
      description: エンドポイント定義を削除
      parameters:
        - $ref: '#/components/parameters/EndpointID'
      responses:
        '200':
          description: エンドポイント削除成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: endpoint deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/auth/settings:
    get:
      tags:
        - Auth
      summary: 認証設定を取得
      description: 現在の認証設定を取得
      responses:
        '200':
          description: 認証設定の取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSettings'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Auth
      summary: 認証設定を更新
      description: 認証設定を更新
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAuthSettingsRequest'
      responses:
        '200':
          description: 認証設定更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthSettings'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/auth/fields:
    get:
      tags:
        - Auth
      summary: ユーザーフィールド一覧を取得
      description: 認証に使用されるユーザーフィールドの一覧を取得
      responses:
        '200':
          description: ユーザーフィールド一覧の取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthFieldsResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/{dynamicPath}:
    get:
      tags:
        - Runtime
      summary: 動的エンドポイントを実行 (GET)
      description: 登録されたフロー定義に基づいて動的にAPIを実行
      parameters:
        - name: dynamicPath
          in: path
          required: true
          description: 動的なエンドポイントパス
          schema:
            type: string
          example: users/list
      responses:
        '200':
          description: 実行成功
          content:
            application/json:
              schema:
                type: object
                description: フロー定義に基づく動的なレスポンス
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Runtime
      summary: 動的エンドポイントを実行 (POST)
      description: 登録されたフロー定義に基づいて動的にAPIを実行
      parameters:
        - name: dynamicPath
          in: path
          required: true
          description: 動的なエンドポイントパス
          schema:
            type: string
          example: users/create
      requestBody:
        content:
          application/json:
            schema:
              type: object
              description: フロー定義に基づく動的なリクエストボディ
      responses:
        '200':
          description: 実行成功
          content:
            application/json:
              schema:
                type: object
                description: フロー定義に基づく動的なレスポンス
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Runtime
      summary: 動的エンドポイントを実行 (PUT)
      description: 登録されたフロー定義に基づいて動的にAPIを実行
      parameters:
        - name: dynamicPath
          in: path
          required: true
          description: 動的なエンドポイントパス
          schema:
            type: string
          example: users/123
      requestBody:
        content:
          application/json:
            schema:
              type: object
              description: フロー定義に基づく動的なリクエストボディ
      responses:
        '200':
          description: 実行成功
          content:
            application/json:
              schema:
                type: object
                description: フロー定義に基づく動的なレスポンス
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Runtime
      summary: 動的エンドポイントを実行 (DELETE)
      description: 登録されたフロー定義に基づいて動的にAPIを実行
      parameters:
        - name: dynamicPath
          in: path
          required: true
          description: 動的なエンドポイントパス
          schema:
            type: string
          example: users/123
      responses:
        '200':
          description: 実行成功
          content:
            application/json:
              schema:
                type: object
                description: フロー定義に基づく動的なレスポンス
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  parameters:
    TableID:
      name: id
      in: path
      required: true
      description: テーブルID
      schema:
        type: string
        format: uuid
      example: 550e8400-e29b-41d4-a716-446655440000

    EndpointID:
      name: id
      in: path
      required: true
      description: エンドポイントID
      schema:
        type: string
        format: uuid
      example: 660e8400-e29b-41d4-a716-446655440000

  schemas:
    # Table関連
    Table:
      type: object
      required:
        - id
        - name
        - columns
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: テーブルID
          example: 550e8400-e29b-41d4-a716-446655440000
        name:
          type: string
          description: テーブル名
          example: users
        columns:
          type: array
          description: カラム定義のリスト
          items:
            $ref: '#/components/schemas/Column'
        created_at:
          type: string
          format: date-time
          description: 作成日時
          example: 2025-01-01T00:00:00Z
        updated_at:
          type: string
          format: date-time
          description: 更新日時
          example: 2025-01-01T00:00:00Z

    Column:
      type: object
      required:
        - id
        - table_id
        - name
        - type
        - required
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: カラムID
          example: 770e8400-e29b-41d4-a716-446655440000
        table_id:
          type: string
          format: uuid
          description: 所属するテーブルのID
          example: 550e8400-e29b-41d4-a716-446655440000
        name:
          type: string
          description: カラム名
          example: email
        type:
          type: string
          description: カラムの型
          enum:
            - text
            - integer
            - uuid
            - timestamp
            - boolean
            - json
          example: text
        required:
          type: boolean
          description: 必須フィールドかどうか
          example: true
        created_at:
          type: string
          format: date-time
          description: 作成日時
          example: 2025-01-01T00:00:00Z
        updated_at:
          type: string
          format: date-time
          description: 更新日時
          example: 2025-01-01T00:00:00Z

    CreateTableRequest:
      type: object
      required:
        - name
        - columns
      properties:
        name:
          type: string
          description: テーブル名
          example: users
        columns:
          type: array
          description: カラム定義のリスト
          minItems: 1
          items:
            $ref: '#/components/schemas/ColumnCreate'

    UpdateTableRequest:
      type: object
      properties:
        name:
          type: string
          description: テーブル名（オプション）
          example: users_v2
        columns:
          type: array
          description: 追加するカラムのリスト（オプション）
          items:
            $ref: '#/components/schemas/ColumnCreate'

    ColumnCreate:
      type: object
      required:
        - name
        - type
      properties:
        name:
          type: string
          description: カラム名
          example: email
        type:
          type: string
          description: カラムの型
          enum:
            - text
            - integer
            - uuid
            - timestamp
            - boolean
            - json
          example: text
        required:
          type: boolean
          description: 必須フィールドかどうか
          default: false
          example: true

    TablesResponse:
      type: object
      required:
        - tables
      properties:
        tables:
          type: array
          description: テーブルのリスト
          items:
            $ref: '#/components/schemas/Table'

    CSVImportRequest:
      type: object
      required:
        - csv_data
      properties:
        csv_data:
          type: string
          description: CSV形式のデータ
          example: |
            id,name,email
            1,John Doe,john@example.com
            2,Jane Smith,jane@example.com

    # Endpoint関連
    Endpoint:
      type: object
      required:
        - id
        - name
        - method
        - path
        - flow
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: エンドポイントID
          example: 660e8400-e29b-41d4-a716-446655440000
        name:
          type: string
          description: エンドポイント名
          example: Get User List
        method:
          type: string
          description: HTTPメソッド
          enum:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
          example: GET
        path:
          type: string
          description: エンドポイントパス
          example: /users/list
        flow:
          $ref: '#/components/schemas/Flow'
        created_at:
          type: string
          format: date-time
          description: 作成日時
          example: 2025-01-01T00:00:00Z
        updated_at:
          type: string
          format: date-time
          description: 更新日時
          example: 2025-01-01T00:00:00Z

    CreateEndpointRequest:
      type: object
      required:
        - name
        - method
        - path
        - flow
      properties:
        name:
          type: string
          description: エンドポイント名
          example: Get User List
        method:
          type: string
          description: HTTPメソッド
          enum:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
          example: GET
        path:
          type: string
          description: エンドポイントパス
          example: /users/list
        flow:
          $ref: '#/components/schemas/Flow'

    UpdateEndpointRequest:
      type: object
      properties:
        name:
          type: string
          description: エンドポイント名（オプション）
          example: Get User List V2
        method:
          type: string
          description: HTTPメソッド（オプション）
          enum:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
          example: POST
        path:
          type: string
          description: エンドポイントパス（オプション）
          example: /users/list/v2
        flow:
          $ref: '#/components/schemas/Flow'

    EndpointsResponse:
      type: object
      required:
        - endpoints
      properties:
        endpoints:
          type: array
          description: エンドポイントのリスト
          items:
            $ref: '#/components/schemas/Endpoint'

    # Flow関連
    Flow:
      type: object
      required:
        - nodes
      properties:
        nodes:
          type: array
          description: フローのノードリスト
          minItems: 1
          items:
            $ref: '#/components/schemas/Node'
        connections:
          type: array
          description: ノード間の接続リスト
          items:
            $ref: '#/components/schemas/Connection'

    Node:
      type: object
      required:
        - id
        - type
        - label
        - pins
      properties:
        id:
          type: string
          description: ノードID
          example: node-1
        type:
          type: string
          description: ノードタイプ
          enum:
            - start
            - database
            - filter
            - response
            - process
          example: start
        label:
          type: string
          description: ノードのラベル
          example: Start
        x:
          type: number
          format: double
          description: X座標（UI用）
          example: 100.0
        y:
          type: number
          format: double
          description: Y座標（UI用）
          example: 200.0
        config:
          type: object
          description: ノード固有の設定（自由形式）
          additionalProperties: true
          example:
            table: users
            operation: select
        pins:
          type: array
          description: ピン（入力/出力ポート）のリスト
          minItems: 1
          items:
            $ref: '#/components/schemas/Pin'

    Pin:
      type: object
      required:
        - id
        - node_id
        - type
        - data_type
        - label
      properties:
        id:
          type: string
          description: ピンID
          example: pin-1
        node_id:
          type: string
          description: 所属するノードのID
          example: node-1
        type:
          type: string
          description: ピンタイプ
          enum:
            - input
            - output
          example: output
        data_type:
          type: string
          description: データ型
          example: object
        label:
          type: string
          description: ピンのラベル
          example: Result

    Connection:
      type: object
      required:
        - id
        - from
        - to
      properties:
        id:
          type: string
          description: 接続ID
          example: conn-1
        from:
          $ref: '#/components/schemas/PinRef'
        to:
          $ref: '#/components/schemas/PinRef'

    PinRef:
      type: object
      required:
        - node_id
        - pin_id
      properties:
        node_id:
          type: string
          description: ノードID
          example: node-1
        pin_id:
          type: string
          description: ピンID
          example: pin-1

    # Auth関連
    AuthSettings:
      type: object
      required:
        - id
        - method
        - config
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: 認証設定ID
          example: 880e8400-e29b-41d4-a716-446655440000
        method:
          type: string
          description: 認証方法
          enum:
            - email
            - oauth
          example: email
        config:
          type: object
          description: 認証方法固有の設定
          additionalProperties: true
          example:
            provider: google
            client_id: xxx
        created_at:
          type: string
          format: date-time
          description: 作成日時
          example: 2025-01-01T00:00:00Z
        updated_at:
          type: string
          format: date-time
          description: 更新日時
          example: 2025-01-01T00:00:00Z

    UpdateAuthSettingsRequest:
      type: object
      required:
        - method
        - config
      properties:
        method:
          type: string
          description: 認証方法
          enum:
            - email
            - oauth
          example: email
        config:
          type: object
          description: 認証方法固有の設定
          additionalProperties: true
          example:
            provider: google
            client_id: xxx

    AuthField:
      type: object
      required:
        - name
        - type
        - required
      properties:
        name:
          type: string
          description: フィールド名
          example: email
        type:
          type: string
          description: フィールドの型
          example: string
        required:
          type: boolean
          description: 必須フィールドかどうか
          example: true

    AuthFieldsResponse:
      type: object
      required:
        - fields
      properties:
        fields:
          type: array
          description: フィールドのリスト
          items:
            $ref: '#/components/schemas/AuthField'

    # エラーレスポンス
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: エラーメッセージ
          example: Invalid request

  responses:
    BadRequest:
      description: リクエストが不正です
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Invalid request body

    NotFound:
      description: リソースが見つかりません
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Resource not found

    InternalServerError:
      description: サーバー内部エラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Internal server error
